## Последовательность завершения работы системы

*За основу взята статья из официального руководства https://networkupstools.org/docs/user-manual.chunked/ar01s06.html#Shutdown_design*

1. ИБП переключается на работу от батареи.
2. Значение заряда батареи (`battery.charge`) доходит до значения `battery.charge.low` (см. вывод команды `upsc <имя_ИБП>@localhost`), при этом `ups.status` равно `OB LB` (точное поведение зависит от конкретного устройства и также может зависеть от `battery.runtime` и `battery.runtime.low`).
3. upsmon на master-системе устанавливает флаг FSD (Forced ShutDown — вынужденное отключение) и сообщает slave-системам, что скоро отключится питание. Если slave-системы отсутствуют (от ИБП работает только одна система) — шаги 4 и 5 пропускаются.
4. upsmon на slave-системах видит флаг FSD и:
	- Генерирует событие `NOTIFY_SHUTDOWN`;
	- Ждёт количество секунд, указанное в параметре `FINALDELAY` — обычно 5 секунд;
	- Вызывает команду, указанную в параметре `SHUTDOWNCMD`;
	- Отключается от upsd.
5. upsmon на master-системе ждёт количество секунд, указанное в параметре `HOSTSYNC` (обычно 15 секунд), пока slave-системы отключатся от upsd. Если по истечении этого времени какой-либо клиент не отключается, наличие этого клиента игнорируется и upsmon переходит к этапу завершения работы master-системы.
6. upsmon на master-системе:
	- Генерирует событие `NOTIFY_SHUTDOWN`;
	- Ждёт количество секунд, указанное в параметре `FINALDELAY` — обычно 5 секунд;
	- Создаёт файл, указанный в параметре `POWERDOWNFLAG` — обычно `/etc/killpower`;
	- Вызывает команду, указанную в параметре `SHUTDOWNCMD`.
7. init завершает процессы, синхронизирует и отмонтирует файловые системы.
8. init вызывает скрипт `/etc/init.d/nut-client`. Он проверяет наличие в системе файла, указанного в параметре `POWERDOWNFLAG`, и, если находит его, даёт драйверу ИБП команду на отключение питания.
9. Система остаётся без питания.
10. Проходит время, на ИБП подаётся питание и ИБП подаёт питание на компьютеры.
11. Все системы запускаются и возвращаются к работе.
